#include <WiFi.h>
#include <WebServer.h>
#include <HX711.h>
#include <Adafruit_SHT4x.h>

// -------- CONFIGURACIÓN WiFi --------
const char* ssid = "Tu_SSID";      // Cambia esto
const char* password = "Tu_PASS";  // Cambia esto

WebServer server(80); // Servidor HTTP en el puerto 80

// -------- CONFIGURACIÓN HX711 --------
#define HX711_DOUT  4
#define HX711_SCK   5
HX711 balanza;

// -------- CONFIGURACIÓN LED --------
#define LED_PIN 2

// -------- SENSOR SHT41 --------
Adafruit_SHT4x sht4 = Adafruit_SHT4x();

// -------- VARIABLES --------
float peso = 0;
float temperatura = 0;
float humedad = 0;
int setControl = 37;  // valor inicial

// ========================================================
// FUNCIONES DE SENSORES
// ========================================================
void leerSensores() {
  if (balanza.is_ready()) {
    peso = balanza.get_units(3);
  }

  sensors_event_t humidity_event, temp_event;
  sht4.getEvent(&humidity_event, &temp_event);
  temperatura = temp_event.temperature;
  humedad = humidity_event.relative_humidity;
}

// ========================================================
// ENDPOINTS DEL SERVIDOR
// ========================================================

// --- Enviar datos de sensores en formato JSON ---
void handleGetData() {
  leerSensores();

  String json = "{";
  json += "\"peso\":" + String(peso, 2) + ",";
  json += "\"temperatura\":" + String(temperatura, 2) + ",";
  json += "\"humedad\":" + String(humedad, 2) + ",";
  json += "\"setControl\":" + String(setControl);
  json += "}";

  server.send(200, "application/json", json);
}

// --- Recibir comandos desde navegador o app ---
void handleCommand() {
  if (server.hasArg("cmd")) {
    String cmd = server.arg("cmd");
    Serial.print("Comando recibido: ");
    Serial.println(cmd);

    if (cmd == "LED_ON") {
      digitalWrite(LED_PIN, HIGH);
      server.send(200, "text/plain", "LED encendido");
    } else if (cmd == "LED_OFF") {
      digitalWrite(LED_PIN, LOW);
      server.send(200, "text/plain", "LED apagado");
    } else if (cmd.startsWith("SET:")) {
      int valor = cmd.substring(4).toInt();
      if (valor >= 34 && valor <= 40) {
        setControl = valor;
        server.send(200, "text/plain", "SetControl actualizado a " + String(valor));
      } else {
        server.send(400, "text/plain", "Valor fuera de rango (34–40)");
      }
    } else {
      server.send(400, "text/plain", "Comando no reconocido");
    }
  } else {
    server.send(400, "text/plain", "Falta argumento 'cmd'");
  }
}

// ========================================================
// SETUP
// ========================================================
void setup() {
  Serial.begin(115200);

  // --- Inicializar LED ---
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW);

  // --- Inicializar HX711 ---
  balanza.begin(HX711_DOUT, HX711_SCK);
  balanza.set_scale(2280.f); // Ajustar con calibración
  balanza.tare();

  // --- Inicializar SHT41 ---
  if (!sht4.begin()) {
    Serial.println("No se encontró el SHT4x");
    while (1) delay(10);
  }

  // --- Conectar a WiFi ---
  Serial.println();
  Serial.print("Conectando a WiFi: ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println();
  Serial.print("Conectado! IP: ");
  Serial.println(WiFi.localIP());

  // --- Configurar rutas del servidor ---
  server.on("/data", handleGetData);     // GET -> obtiene datos
  server.on("/cmd", handleCommand);      // GET -> envía comando
  server.begin();
  Serial.println("Servidor iniciado!");
}

// ========================================================
// LOOP PRINCIPAL
// ========================================================
void loop() {
  server.handleClient(); // Atiende peticiones web
}
